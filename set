#!/bin/bash
#
# Save the colorscheme generated by wal permanently into i3 / sway, i3 status and termite configs
# Also update the lock and dmenu script

# variables
color_src="${HOME}/.cache/wal/colors"
IFS=$'\r\n'
colors=( $(cat ${color_src}) )

locksh="${HOME}/lock.sh"
dmenush="${HOME}/dmenu.sh"

# no idea how to describe the function of this

# Speed up script by not using unicode.
sys_locale="$LANG"
export LC_ALL=C
export LANG=C
 
shopt -s nullglob nocasematch

# Config files for Xresources, i3 / sway, i3status, termite and dunst 
xres="${HOME}/.Xresources"

i3_sway="${HOME}/.config/i3/config"
if [[ $DESKTOP_SESSION == *"sway" ]]; then
	i3_sway="${HOME}/.config/sway/config"
fi

termite="${HOME}/.config/termite/config"
dunstrc="${HOME}/.config/dunst/dunstrc"
i3status="${HOME}/.config/i3status/config"

files=( 'termite' 'i3_sway' 'locksh' 'dmenush') 

# loop through the files array, the update process for all these files is very similar
for f in ${files[@]}; do
	
	# loop through colors
	for i in ${!colors[@]}
	do
		# where to insert the color configuration
		colors_following="#Color config"
		# any prefix needed
	 	pre=""
		# any equal sign needed
		equals="="	

		# the i3 / sway config file needs different syntax for setting the vars
		if  [[ $f == *"sway" ]]; then
			pre="set \$"
			equals="\t"
		fi

		# the termite config file has a [color] section
		if [[ $f == *"termite" ]]; then
			colors_following="\[colors\]"
		fi
		
		# create a string for each file containing the color configuration
		#new line after every color but the last, bg = 1st color, fg = 8th color
		eval "${f}_str"+="'${pre}color${i}${equals}${colors[$i]}'"
		if [[ $i -lt `expr ${#colors[@]} - 1` ]]; then 
			eval "${f}_str"+="'\n'"
		fi
		if [[ $i -eq 0 ]]; then
		   	eval "${f}_str"+="'${pre}background${equals}${colors[$i]}\n'"
		fi
		if [[ $i -eq 7 ]]; then
			eval "${f}_str"+="'${pre}foreground${equals}${colors[$i]}\n'"
		fi

	done
	
	# helper variable for indirect expansion
	str=${f}_str

	# insert all the configuration into all the files, clean up before
	echo ${!f}	
	sed -i "/^${pre}foreground*/d" ${!f}
	sed -i "/^${pre}background*/d" ${!f}
	sed -i "/^${pre}color[0-9]/d" ${!f}
	
	sed -i "/$colors_following/a ${!str}" ${!f}
done
		
# replace color configuration in i3status and dunst configuration files
sed -i "/color_good/ s/\#[[:alnum:]]\{6\}/${colors[15]}/" ${i3status} #12
sed -i "/color_bad/ s/\#[[:alnum:]]\{6\}/${colors[8]}/" ${i3status}        #6
sed -i "/color_degraded/ s/\#[[:alnum:]]\{6\}/${colors[2]}/" ${i3status} #3

sed -i "/^color/ s/\#[[:alnum:]]\{6\}/${colors[7]}/" $dunstrc
sed -i "/^foreground/ s/\#[[:alnum:]]\{6\}/${colors[14]}/" $dunstrc
sed -i "/^background/ s/\#[[:alnum:]]\{6\}/${colors[0]}/" $dunstrc

# restart i3 desktop; sway cant not yet be restarted using the shell
if  [[ $DESKTOP_SESSION == *"i3" ]]; then
	i3-msg restart
fi
